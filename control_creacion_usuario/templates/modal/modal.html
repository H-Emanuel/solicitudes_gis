    <div class="modal fade" id="registroPreviewModal" tabindex="-1" aria-labelledby="registroPreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #707eff;">
                    <h5 class="modal-title" id="registroPreviewModalLabel">Vista previa de registros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="registroPreviewData"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="Nueva_fecha_Designio" tabindex="-1" role="dialog"
        aria-labelledby="Nueva_fecha_DesignioLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="Nueva_fecha_DesignioLabel">Designación de Dias hábiles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="fechaNueva">Seleccione la nueva fecha y hora:</label>
                    <input type="datetime-local" id="fechaNueva" class="form-control">
                    <div id="errorFecha" class="text-danger mt-2" style="display: none;">La fecha seleccionada no puede
                        ser un sábado o domingo.</div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="guardarFecha">Guardar Nueva Fecha</button>

                </div>
            </div>
        </div>
    </div>


    <!-- Modal para agregar apoyos al protocolo -->
    <div class="modal fade" id="apoyoModal" tabindex="-1" aria-labelledby="apoyoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="apoyoModalLabel">Agregar Apoyos al Protocolo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <p><strong>Protocolo ID:</strong> <span id="protocoloId"></span></p>
            <p><strong>Profesional Responsable:</strong> <span id="profesionalActual"></span></p>
            <p>Selecciona los usuarios que deseas agregar como apoyo:</p>
            <div id="listaApoyos">
                <!-- Aquí se insertarán dinámicamente los checkboxes de usuarios -->
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="guardarApoyo">Guardar</button>
            </div>
        </div>
        </div>
    </div>

    <!-- Modal para agregar apoyos al protocolo -->
    <div class="modal fade" id="notaModal" tabindex="-1" aria-labelledby="notaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notaModalLabel">Peso del Protocolo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Protocolo ID:</strong> <span id="protocoloId_modal"></span></p>
                    <p><strong>Profesional Responsable:</strong> <span id="profesionalActual_modal"></span></p>
    
                    <!-- Control del porcentaje TOTAL -->
                    <p><strong>Distribución de Trabajo</strong></p>
                    <div class="d-flex align-items-center">
                        <input type="range" id="porcentajeSliderTotal" min="0" max="100" step="5" value="100" class="form-range">
                        <input type="number" id="porcentajeInputTotal" min="0" max="100" step="5" value="100" class="form-control mx-2" style="width: 80px;">
                    </div>
    
                    <!-- Sección de distribución si hay apoyo (Oculta por defecto) -->
                    <div id="distribucionSection" style="display: none;">
                        <p><strong>Profesional</strong></p>
                        <div class="d-flex align-items-center">
                            <input type="range" id="porcentajeSliderProfesional" min="0" max="100" step="5" value="100" class="form-range">
                            <input type="number" id="porcentajeInputProfesional" min="0" max="100" step="5" value="100" class="form-control mx-2" style="width: 80px;">
                        </div>
    
                        <p><strong>Apoyo(s)</strong></p>
                        <div class="d-flex align-items-center">
                            <input type="range" id="porcentajeSliderApoyo" min="0" max="100" step="5" value="100" class="form-range">
                            <input type="number" id="porcentajeInputApoyo" min="0" max="100" step="5" value="100" class="form-control mx-2" style="width: 80px;">
                        </div>
    
                        <!-- Nombres de los apoyos -->
                        <p><strong>Lista de Apoyos</strong></p>
                        <ul id="listaApoyos" style="padding-left: 20px;"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="GuardarNota">Guardar</button>
                </div>
            </div>
        </div>
    </div>

        <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #707eff;">
                    <h5 class="modal-title" id="previewModalLabel">Vista previa de solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <p id="previewData"></p>
                </div>
            </div>

        </div>
    </div>
    <!-- Modal Dinámico de ENVIAR AL CORREO -->
    <div class="modal fade" id="dynamicEmailModal" tabindex="-1" aria-labelledby="dynamicEmailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dynamicEmailModalLabel">Enviar Correo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dynamicEmailForm">
                        <!-- Campo para agregar correos -->

                        <div class="mb-3">
                            <label for="emailInput" class="form-label">1. Destinatario</label>
                            <ul id="destinatarioList" class="list-group mb-3">
                                <!-- Aquí se mostrará dinámicamente el destinatario -->
                            </ul>
                        </div>


                        <div class="mb-3">
                            <label for="emailInput" class="form-label">2. Agregar en copia</label>
                            <input type="email" class="form-control" id="emailInput" placeholder="Ingresa un correo">
                        </div>
                        
                        <textarea class="form-control" id="messageText" rows="5" placeholder="Escribe tu mensaje aquí">{% if request.user.is_superuser %}Estimado,
                        Por favor, proceda con la solicitud según corresponda.
                        Agradezco su atención.
                        Atte.{% else %}Estimado Solicitante,
                        Atte.{% endif %}
                        </textarea>



                        <!-- Campo para adjuntar archivos -->
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">4. Adjuntar el o los archivos(10 mb se adjuntar
                                normalmente, 300mb sera exportado a link. )</label>
                            <input type="file" class="form-control" id="fileInput" multiple>
                        </div>

                        <!-- Lista de archivos adjuntados -->
                        <ul id="fileList" class="list-group mb-3"></ul>
                    </form>
                </div>
                <br>
                <div id="loadingSpinner" class="text-center mb-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Enviando...</span>
                    </div>
                    <p>Enviando datos, por favor espera...</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="sendData()">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Bootstrap para el motivo del cambio -->
    <div class="modal fade" id="registro_De_Designio" tabindex="-1" role="dialog"
        aria-labelledby="registro_De_DesignioLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registro_De_DesignioLabel">Motivo del cambio de profesional</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                </div>
                <div class="modal-body">
                    <form id="motivoCambioForm">
                        <div class="form-group">
                            <label for="motivo">Motivo del cambio</label>
                            <textarea class="form-control" id="motivo" name="motivo" rows="3" required></textarea>
                        </div>
                        <input type="hidden" id="nuevo_profesional_id" name="nuevo_profesional_id">
                        <input type="hidden" id="solicitud_id" name="solicitud_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="guardarMotivo">Guardar motivo</button>
                </div>
            </div>
        </div>
    </div>

    
    <script>
$(document).on("click", ".apoyo-link", function (event) {
    event.preventDefault();

    var item = JSON.parse($(this).attr("data-item"));
    var protocoloId = item.id;
    var profesionalActual = item.profesional_id ? `${item.profesional_nombre}` : "No asignado";

    $("#protocoloId").text(protocoloId);
    $("#profesionalActual").text(profesionalActual);

    // Llamada AJAX para obtener usuarios disponibles
    $.ajax({
        url: "{% url 'usuarios_disponibles' %}",
        type: "GET",
        data: { protocolo_id: protocoloId },
        success: function (response) {
            var container = $("#listaApoyos");
            container.empty();

            response.usuarios.forEach(function (usuario) {
                // Si ya está agregado, el checkbox se marca por defecto
                var checked = usuario.ya_agregado ? "checked" : "";
                container.append(`
                    <div class="form-check">
                      <input class="form-check-input apoyo-checkbox" type="checkbox" value="${usuario.id}" id="usuario_${usuario.id}" ${checked}>
                      <label class="form-check-label" for="usuario_${usuario.id}">
                        ${usuario.first_name} ${usuario.last_name}
                      </label>
                    </div>
                `);
            });

            $("#apoyoModal").modal("show");
        },
        error: function () {
            alert("Error al obtener usuarios disponibles.");
        }
    });
});


$("#guardarApoyo").click(function () {
    var protocoloId = $("#protocoloId").text();
    var usuariosSeleccionados = [];
    $(".apoyo-checkbox:checked").each(function () {
        usuariosSeleccionados.push($(this).val());
    });

    if (usuariosSeleccionados.length > 1) {
        Swal.fire({
            icon: 'warning',
            title: 'Atención',
            text: 'Solo puedes seleccionar un usuario como apoyo.'
        });
        return;
    }

    $.ajax({
        url: "{% url 'agregar_apoyo' %}",
        type: "POST",
        data: {
            protocolo_id: protocoloId,
            usuarios: JSON.stringify(usuariosSeleccionados),
            csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        success: function (response) {
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: 'Apoyo actualizado con éxito.'
            }).then(() => {
                $("#apoyoModal").modal("hide");
                location.reload();
            });
        },
        error: function () {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Hubo un problema al actualizar el apoyo.'
            });
        }
    });
});

</script>
<script>
$(document).on("click", ".nota-link", function (event) {
    event.preventDefault();

    var item = JSON.parse($(this).attr("data-item"));
    var protocoloId = item.id;
    var profesionalActual = item.profesional_id ? `${item.profesional_nombre}` : "No asignado";

    $("#protocoloId_modal").text(protocoloId);
    $("#profesionalActual_modal").text(profesionalActual);

    // Llamada AJAX para obtener datos previos
    $.ajax({
        url: "/obtener_nota/",
        type: "GET",
        data: { protocolo_id: protocoloId },
        success: function (response) {
            var apoyoContainer = $("#listaApoyos");
            apoyoContainer.empty();

            // Convertir valores de decimal a 0.XX
            var porcentajeTotal = response.porcentaje_total;
            var porcentajeProfesional = response.porcentaje_profesional;
            var porcentajeApoyo = response.porcentaje_apoyo;

            $("#porcentajeSliderTotal").val(porcentajeTotal);
            $("#porcentajeInputTotal").val(porcentajeTotal);
            $("#porcentajeSliderProfesional").val(porcentajeProfesional);
            $("#porcentajeInputProfesional").val(porcentajeProfesional);
            $("#porcentajeSliderApoyo").val(porcentajeApoyo);
            $("#porcentajeInputApoyo").val(porcentajeApoyo);

            // Mostrar la distribución solo si hay apoyos
            if (response.apoyos.length > 0) {
                $("#distribucionSection").show();
                response.apoyos.forEach(function (usuario) {
                    apoyoContainer.append(`<li>${usuario.first_name} ${usuario.last_name}</li>`);
                });
            } else {
                $("#distribucionSection").hide();
            }

            $("#notaModal").modal("show");
        },
        error: function () {
            alert("Error al obtener los apoyos del protocolo.");
        }
    });
});


</script>

<script>
    var csrf_token = "{{ csrf_token }}";  // Pasar el CSRF Token a JS
</script>

<script>
$(document).on("click", "#GuardarNota", function () {
    var protocoloId = $("#protocoloId_modal").text().trim();
    var porcentajeTotal = parseFloat($("#porcentajeInputTotal").val());  // Tomar el valor de "Distribución de Trabajo"

    // Si no hay apoyo, el profesional toma el 100% del total
    var porcentajeProfesional = porcentajeTotal;
    var porcentajeApoyo = 0;

    // Si hay apoyo, tomamos los valores ajustados por el usuario
    if ($("#distribucionSection").is(":visible")) {
        porcentajeProfesional = parseFloat($("#porcentajeInputProfesional").val());
        porcentajeApoyo = parseFloat($("#porcentajeInputApoyo").val());
    }

    // Obtener los apoyos seleccionados
    var apoyosSeleccionados = [];
    $(".apoyo-checkbox:checked").each(function () {
        apoyosSeleccionados.push($(this).val());
    });

    // Validar que los valores no sean NaN
    if (isNaN(porcentajeTotal) || isNaN(porcentajeProfesional) || isNaN(porcentajeApoyo)) {
        alert("Error: Valores inválidos.");
        return;
    }

    // Asegurar que la suma de profesional y apoyo no exceda el total
    var sumaDistribucion = porcentajeProfesional + porcentajeApoyo;
    if (sumaDistribucion > porcentajeTotal) {
        alert("Error: La distribución entre profesional y apoyo no puede exceder el total asignado.");
        return;
    }

    // Ajustar valores en caso de desajustes
    if (sumaDistribucion < porcentajeTotal) {
        porcentajeProfesional = (porcentajeProfesional / sumaDistribucion) * porcentajeTotal;
        porcentajeApoyo = (porcentajeApoyo / sumaDistribucion) * porcentajeTotal;
    }

    // Enviar datos mediante AJAX
    $.ajax({
        url: "/guardar_nota/",  // Ruta de la API en Django
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            protocolo_id: protocoloId,
            porcentaje_total: porcentajeTotal, 
            porcentaje_profesional: porcentajeProfesional, 
            porcentaje_apoyo: porcentajeApoyo,
            apoyos: apoyosSeleccionados  // Enviar la lista de IDs de los apoyos
        }),
        headers: { "X-CSRFToken": csrf_token }, // Pasar el CSRF Token
        success: function (response) {
            if (response.success) {
                alert("Datos guardados correctamente.");
                $("#notaModal").modal("hide");
                location.reload(); // Recargar la página para reflejar cambios
            } else {
                alert("Error: " + response.error);
            }
        },
        error: function () {
            alert("Error al guardar la nota.");
        }
    });
});

</script>

<script>
    $(document).ready(function () {
    // Sincronizar el slider total con el input numérico
    $("#porcentajeSliderTotal").on("input", function () {
        $("#porcentajeInputTotal").val($(this).val());
        actualizarDistribucion();
    });

    $("#porcentajeInputTotal").on("input", function () {
        var valor = Math.min(100, Math.max(0, $(this).val())); // Asegurar entre 0-100
        $("#porcentajeSliderTotal").val(valor);
        actualizarDistribucion();
    });

    // Sincronizar el slider del profesional con su input
    $("#porcentajeSliderProfesional").on("input", function () {
        $("#porcentajeInputProfesional").val($(this).val());
        actualizarDistribucion();
    });

    $("#porcentajeInputProfesional").on("input", function () {
        var valor = Math.min(100, Math.max(0, $(this).val())); // Asegurar entre 0-100
        $("#porcentajeSliderProfesional").val(valor);
        actualizarDistribucion();
    });

    // Sincronizar el slider del apoyo con su input
    $("#porcentajeSliderApoyo").on("input", function () {
        $("#porcentajeInputApoyo").val($(this).val());
        actualizarDistribucion();
    });

    $("#porcentajeInputApoyo").on("input", function () {
        var valor = Math.min(100, Math.max(0, $(this).val())); // Asegurar entre 0-100
        $("#porcentajeSliderApoyo").val(valor);
        actualizarDistribucion();
    });

    // Función para distribuir el trabajo sin exceder el total
    function actualizarDistribucion() {
        var totalDistribucion = parseFloat($("#porcentajeSliderTotal").val());
        var profesional = parseFloat($("#porcentajeSliderProfesional").val());
        var apoyo = parseFloat($("#porcentajeSliderApoyo").val());

        // Si la suma excede el total, ajustar proporcionalmente
        if (profesional + apoyo > totalDistribucion) {
            var factor = totalDistribucion / (profesional + apoyo);
            profesional *= factor;
            apoyo *= factor;
        }

        // Actualizar valores
        $("#porcentajeSliderProfesional").val(profesional);
        $("#porcentajeInputProfesional").val(profesional.toFixed(0));
        $("#porcentajeSliderApoyo").val(apoyo);
        $("#porcentajeInputApoyo").val(apoyo.toFixed(0));
    }
});

</script>
