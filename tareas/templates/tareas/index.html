{% load widget_tweaks %}
{% load static %}

{% load static %}

{% block main_content%}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Repositorio de Tareas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <title>Enhanced Select</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <link href="{% static 'css/base.css' %}" rel="stylesheet" />
    <!-- Hojas de estilo específicas -->
    <link href="{% static 'css/slide.css' %}" rel="stylesheet" />
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version) -->
    <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Datatables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css" />

    <!-- Custom CSS -->

    <!-- sweetalert2  -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=text_snippet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=forward_to_inbox" />


    <style>
        
         /* Estilos globales */


.card-header {
    background: linear-gradient(to right, #0f52a9, #0f52a9) !important;
    border-bottom: none; /* Opcional: elimina el borde inferior si es necesario */
}
body {
    background: #d1efee;
    font-family: 'Roboto', sans-serif;
    color: #333;
    margin: 0;
    padding: 0;
}

/* Encabezados */
h1 {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 20px;
}

h1.text-primary {
    color: #007bff;
}

/* Elementos de lista */
.list-group-item {
    background-color: #fff;
    padding: 20px;
    margin: 15px 0;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.list-group-item:hover {
    transform: translateY(-5px);
}

/* Paginación */
.pagination {
    display: flex;
    justify-content: center;
    margin: 30px 0;
}

.pagination a {
    margin: 0 8px;
    text-decoration: none;
    padding: 8px 14px;
    border: 1px solid #2c3e50;
    border-radius: 5px;
    transition: background-color 0.3s, color 0.3s;
    color: #2c3e50;
}

.pagination a:hover {
    background-color: #2c3e50;
    color: #fff;
}

.pagination .step-links a {
    color: #2c3e50;
}

.pagination .step-links .current {
    color: #495057;
    font-weight: bold;
}

.pagination .step-links a:hover {
    text-decoration: underline;
}

/* Tareas */
.task-item {
    transition: background-color 0.3s;
}

.task-item:hover {
    background-color: #f2f2f2;
    cursor: pointer;
}

/* Botones */
.btn-success,
.btn-primary,
.btn-danger {
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    color: #fff;
    transition: background-color 0.3s;
    cursor: pointer;
    display: inline-block;
    text-align: center;
}

/* Botón Verde */
.btn-success {
    background-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
}

/* Botón Azul */
.btn-primary {
    background-color: #007bff;
}

.btn-primary:hover {
    background-color: #0069d9;
}

/* Botón Rojo */
.btn-danger {
    background-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
}

/* Texto Secundario */
.text-muted {
    color: #6c757d !important;
}

.apoyo-lista {
  list-style-type: none;
  padding: 0;
  margin: 10px 0;
}

.apoyo-item {
  margin-bottom: 5px;
}

    </style>
<style>
.task-card {
    background-color: #ffffff;
    border-radius: 29px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.8);
    margin-bottom: 20px;
    overflow: hidden;
    transition: transform 0.3s ease;
}

.task-card:hover {
    transform: translateY(-5px);
}

.task-header {
    background: linear-gradient(to right, #47BF0F, #CEF2B3);
    color: #ffffff;
    padding: 15px;
}

.task-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin: 0;
}

.task-status {
    background-color: #33ff00;
    border-radius: 12px;
    color: #000000;
    display: inline-block;
    font-size: 0.75rem;
    margin-top: 8px;
    padding: 3px 8px;
}

.task-body {
    padding: 15px;
}

.task-info p {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.task-info i {
    margin-right: 8px;
    color: #6b7280;
}

.task-priority {
    border-radius: 12px;
    display: inline-block;
    font-size: 0.75rem;
    padding: 3px 8px;
}

.task-priority.baja {
    background-color: #d1fae5;
    color: #065f46;
}

.task-priority.media {
    background-color: #fef3c7;
    color: #92400e;
}

.task-priority.alta {
    background-color: #fee2e2;
    color: #991b1b;
}

.task-support {
    border-top: 1px solid #e9ebe5;
    margin-top: 15px;
    padding-top: 15px;
}

.support-list {
    list-style-type: none;
    padding: 0;
}

.support-list li {
    margin-bottom: 5px;
}

.task-actions {
    background-color: #f3f4f6;
    display: flex;
    justify-content: flex-end;
    padding: 10px;
}

.btn {
    align-items: center;
    border-radius: 10px;
    display: inline-flex;
    font-size: 0.7rem;
    margin-left: 8px;
    padding: 6px 7px;
    text-decoration: none;
    transition: background-color 0.3s ease;
}

.btn i {
    margin-right: 4px;
}

.btn-edit {
    background-color: #ffc107;
    color: #374151;
    width: 90px; /* Ancho fijo (ajusta este valor) */
    height: 35px; /* Altura fija (ajusta este valor) */
    padding: 5px 10px;
    font-size: 0.8em; /* Tamaño de fuente (ajustado) */
    display: inline-flex; /* Usar flexbox para centrar verticalmente */
    align-items: center; /* Centrar verticalmente */
    justify-content: center; /* Centrar horizontalmente */
    border: none; /* Eliminar borde predeterminado */
    border-radius: 29px; /* Ajusta el radio del borde si lo deseas */
    transition: all 0.2s ease; /* Transición suave para el hover */
}

.btn-edit:hover {
    background-color: #d1d5db;
}

.btn-delete {
    background-color: #ef4444;
    color: #ffffff;
}

.btn-delete:hover {
    background-color: #dc2626;
}

.btn-complete {
    background-color: #10b981;
    color: #ffffff;
}

.btn-complete:hover {
    background-color: #059669;
}

.task-card {
    /* ... existing styles ... */
    transition: transform 0.3s ease, opacity 0.3s ease;
}

@keyframes slideAndFade {
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.input-personalizado {
    background-color: #f8f9fa !important; /* Gris claro */
    border-color: #ced4da !important; /* Gris claro */
    color: #343a40 !important; /* Gris oscuro */
}

.label-personalizado {
    color: #000000 !important; /* Gris medio */
}

.select-personalizado {
    background-color: #f8f9fa !important; /* Gris claro */
    border-color: #ced4da !important; /* Gris claro */
    color: #343a40 !important; /* Gris oscuro */
}

.boton-secundario {
    background-color: #6c757d !important; /* Gris medio */
    border-color: #6c757d !important; /* Gris medio */
    color: #ffffff !important; /* Blanco */
}

.boton-primario {
    background-color: #007bff !important; /* Azul */
    border-color: #007bff !important; /* Azul */
    color: #ffffff !important; /* Blanco */
}
</style>
<style>
    .custom-header {
        background-color: #CEF2B3 !important; /* Color naranja */
        color: rgb(10, 0, 0);
    }
</style>

<style>
    /* Optional: Customize Select2 appearance */
    .select2-container--default .select2-selection--single {
        height: 38px; /* Adjust height as needed */
        padding: 6px 12px;
        border: 2px solid #ced4da;
        border-radius: 40px;
        background-color: #fff;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 26px; /* Adjust line height to center text */
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        top: 50%;
        transform: translateY(-50%);
    }


</style>
<style>
    .btn-details {
        background-color: #fdfdfd; /* Azul brillante */
        color: #1E90FF;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .btn-details:hover {
        background-color: #fcfcfc; /* Azul un poco más oscuro al pasar el cursor */
    }


  </style>

    </style>
</head>

<nav class="navbar navbar-expand-sm navbar-dark bg-neumorphic navbar-custom" aria-label="Third navbar example">
    <a href="https://municipalidaddevalparaiso.cl/"><img src="https://departamentosig.munivalpo.cl/media/assets/imagen_sig/None/adjunto_jOZmpn7.png" height="100" alt="Caluga Administrativa" /></a>
   <a href="{% url 'inicio' %}"><img src="/media/assets/image/version-color-corporativo-caluga-logoSIG.png" alt="Logo SIG" height="100" /></a> 
    <div class="container-fluid">
      <p class="navbar-brand" href="{% url 'control' %}">INTERNO</p>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample03" aria-controls="navbarsExample03" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarsExample03">
        {% if request.user.is_authenticated %}

        <ul class="navbar-nav col-lg-10 justify-content-lg-center">
     
          <li class="nav-link">
            <a class="nav-link" href="{% url 'solicitude_llegadas' %}">Solicitudes </a>
          </li>
          <li class="nav-link">
            <a class="nav-link" href="/tareas/">Tareas SIG</a>
          </li>
          <li class="nav-link">
            <a class="nav-link" href="{% url 'control' %}">Estadísticas</a>
          </li>
        </ul>


       

        <div class="d-lg-flex col-lg-3 justify-content-lg-end">
          <ul class="navbar-nav me-auto mb-2 mb-sm-0">

            <li class="nav-item dropdown">

              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" style="height: 40px;">
                  <!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                  <path d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z"/>
                </svg>
              </a>

              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{% url 'solicitude_llegadas' %}">Solicitudes</a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'Historial_Visitas' %}">Historial usuarios</a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'Gestion_imagen' %}">Gestion de imagenes SIG</a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'Gestion_pdf' %}">Gestion de PDF SIG</a>
                </li>

                <li>
                  <a class="dropdown-item" href="{% url 'cambiar_contraseña' %}">Cambiar Contraseña</a>
                </li>


                  {% if request.user.is_staff and request.user.is_authenticated %}
                    <li>
                      <a class="dropdown-item" href="{% url 'delegar_admin' %}">Asignar ADMIN</a>
                    </li>
                  {% endif %}
        
                  <li>
                    <a class="dropdown-item" href="{% url 'logout' %}">Cerrar Sesión</a>
                  </li>
          </li>

          </ul>

        </div>
        {% endif %}

      </div>
    </div>
  </nav>


<div class="container py-4"> 

    <div class="text-center mb-4">
        <h1 class="text-primary"> ✏️ Tareas SIG</h1>
    </div>


    <div class="mb-4 d-flex align-items-center gap-2">
        <select id="funcionarioSelect" class="form-select" data-url="{% url 'tareas_por_funcionario' 0 %}">
            <option value="">Seleccione un funcionario</option>
            {% for funcionario in funcionarios %}
            <option value="{{ funcionario.id }}">{{ funcionario }}</option>
            {% endfor %}
        </select>
        {% if request.user.is_superuser %}
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#agregarTareaModal">
            ➕ Agregar Tarea
        </button>
        {% endif %}
        <button type="button" id="verTareasBtn" class="btn btn-primary btn-sm">Tareas completadas</button>
    </div>
    
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Lista de Tareas </h5>
        </div>
        <div class="card-body" id="listaTareas">
            {% if tareas %}
            <ul class="list-group">
                {% for tarea in tareas %}
                <li class="list-group-item d-flex justify-content-between align-items-center task-item" data-tarea-id="{{ tarea.id }}">
                    <div class="col-3">
                        <span>
                            <strong>{{ tarea.descripcion }}</strong> - {{ tarea.funcionario.nombre }}<br>
                            Fecha de Creación: {{ tarea.fecha_creacion|date:"d-m-Y" }} <br>
                            Fecha de Entrega: {{ tarea.fecha_entrega|date:"d-m-Y" }}<br>
                            <span style="font-weight: bold; color: #333;">Prioridad:</span> 
                            <span class="{% if tarea.prioridad == 'alta' %}text-danger{% elif tarea.prioridad == 'media' %}text-warning{% else %}text-success{% endif %}">
                                {{ tarea.get_prioridad_display }}
                            </span><br>
                        </span>
                    </div>
                    <div class="justify-content-center text-align-start" style="width: 250px;">
                        <strong>Apoyo(s):</strong>
                        {% if tarea.apoyo.all %}
                            <ul class="apoyo-lista">
                                {% for apoyo in tarea.apoyo.all %}
                                    <li class="apoyo-item">
                                        <strong>{{ apoyo.nombre }}:</strong> {{ apoyo.descripcion|default:"No disponible" }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <span>No hay funcionarios de apoyo.</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong style="color: green; font-weight: bold;">En Proceso</strong>
                    </div>
                    <div>
                        <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-sm btn-warning">✏️ Editar</a>
                        {% if request.user.is_superuser %}
                        <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-sm btn-danger"onclick="confirmarEliminacion(event, this)" data-tarea-id="{{ tarea.id }}">️ Eliminar</a>
                    </a>
                            <button type="button" class="btn btn-sm btn-success completar-tarea" data-tarea-id="{{ tarea.id }}">✅ Completar</button>
                        {% endif %}
                    </div>
                </li>

                
                {% endfor %}
            </ul>
            <ul class="pagination">
                {% if tareas.has_previous %}
                    
                    <li class="page-item">
                        <a class="page-link" href="?page={{ tareas.previous_page_number }}" aria-label="Anterior">Anterior</a>
                    </li>
                {% endif %}
                
                {% for i in tareas.paginator.page_range %}
                    <li class="page-item {% if tareas.number == i %}active{% endif %}">
                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                    </li>
                {% endfor %}
                
                {% if tareas.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ tareas.next_page_number }}" aria-label="Siguiente">Siguiente</a>
                    </li>
                    
                {% endif %}
            </ul>
            {% else %}
            <p class="text-muted text-center">⚠️ No hay tareas registradas.</p>
            {% endif %}
        </div>
    </div>
    <div class="text-center mb-4 col">
        <a href="/solicitude_llegadas" class="btn btn-primary btn-sm ">Volver</a>
    </div>
    
    <div id="pagination-container"></div>
    
    <div class="modal fade" id="agregarTareaModal" tabindex="-1" aria-labelledby="agregarTareaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-header border-bottom-0 p-4">
                    <h1 class="modal-title fs-5 fw-bold" id="agregarTareaModalLabel">Agregar Tarea</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <form method="post" id="tareaForm" action="{% url 'agregar_tarea' %}">
                        {% csrf_token %}
    
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control rounded-3 border-0 bg-light input-personalizado" id="descripcion" placeholder="Descripción" name="{{ form.descripcion.html_name }}" required>
                            <label for="descripcion" class="text-secondary label-personalizado">Descripción</label>
                            {% if form.descripcion.errors %}
                                <div class="invalid-feedback">
                                    {{ form.descripcion.errors }}
                                </div>
                            {% endif %}
                        </div>
    
                        <div class="form-floating mb-3">
                            <select class="form-control rounded-3 border-0 bg-light select-personalizado" id="funcionario" name="{{ form.funcionario.html_name }}" required>
                                <option value="">Seleccionar funcionario</option>
                                {% for funcionario in funcionarios %}
                                    <option value="{{ funcionario.id }}">{{ funcionario.nombre }}</option>
                                {% endfor %}
                            </select>
                            <label for="funcionario" class="text-secondary label-personalizado">Funcionario</label>
                            {% if form.funcionario.errors %}
                                <div class="invalid-feedback">
                                    {{ form.funcionario.errors }}
                                </div>
                            {% endif %}
                        </div>
    
                        <div class="mb-3">
                            <label for="{{ form.apoyo.id_for_label }}" class="form-label text-secondary label-personalizado">Apoyo(s) (puedes seleccionar varios):</label>
                            {{ form.apoyo }}
                        </div>
    
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control rounded-3 border-0 bg-light input-personalizado" id="fecha_entrega" placeholder="Fecha de Entrega" name="{{ form.fecha_entrega.html_name }}" required>
                            <label for="fecha_entrega" class="text-secondary label-personalizado">Fecha de Entrega</label>
                            {% if form.fecha_entrega.errors %}
                                <div class="invalid-feedback">
                                    {{ form.fecha_entrega.errors }}
                                </div>
                            {% endif %}
                        </div>
    
                        <div class="form-floating mb-3">
                            <select class="form-control rounded-3 border-0 bg-light select-personalizado" id="prioridad" name="{{ form.prioridad.html_name }}" required>
                                <option value="">Seleccionar prioridad</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                            <label for="prioridad" class="text-secondary label-personalizado">Prioridad</label>
                            {% if form.prioridad.errors %}
                                <div class="invalid-feedback">
                                    {{ form.prioridad.errors }}
                                </div>
                            {% endif %}
                        </div>
    
                        <div class="modal-footer border-top-0 p-4">
                            <button type="button" class="btn btn-secondary rounded-3 me-2 boton-secundario" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary rounded-3 boton-primario">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="confirmarEliminacionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="bi bi-trash-fill text-danger fs-1"></i>
                    <p class="mt-3 fs-5">¿Estás seguro de que quieres eliminar esta tarea?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <a href="#" id="confirmarEliminarBtn" class="btn btn-danger px-4 rounded-pill">
                        <i class="bi bi-trash"></i> Eliminar
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="tareaCompletadaModal" tabindex="-1" aria-labelledby="tareaCompletadaModalLabel" aria-hidden="true">
    
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tareaCompletadaModalLabel">Tarea Terminada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    La tarea se ha marcado como completada exitosamente.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="closeTareaCompletadaModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>



$(document).ready(function() {
    $('#funcionarioSelect').select2();

    $('#verTareasBtn').click(function() {
        let funcionarioId = $('#funcionarioSelect').val();
        if (funcionarioId) {
            let baseUrl = $('#funcionarioSelect').data('url');
            let targetUrl = baseUrl.replace('0', funcionarioId);
            window.location.href = targetUrl;
        } else {
            alert("Por favor, seleccione un funcionario.");
        }
    });

    $('#funcionarioSelect').change(function() {
        let funcionarioId = $(this).val();
        let listaTareas = $('#listaTareas');
        let paginationContainer = $('#pagination-container');
        let baseUrl = $('#funcionarioSelect').data('url');

        if (!funcionarioId) {
            listaTareas.html('<p class="text-muted text-center">⚠️ Seleccione un funcionario para ver sus tareas.</p>');
            paginationContainer.empty();
            return;
        }

        let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';
        let urlWithParam = jsonUrl + '?funcionario=' + funcionarioId;

        loadTasks(urlWithParam); // Llamamos a la función global loadTasks

        const urlParams = new URLSearchParams(window.location.search);
        const funcionarioIdFromUrl = urlParams.get('funcionario');
        if (funcionarioIdFromUrl) {
            $('#funcionarioSelect').val(funcionarioIdFromUrl).trigger('change');
        }
    });
});

// 🛠️ Mover la función loadTasks() fuera para que sea accesible desde cualquier parte
function loadTasks(urlWithParam, page = 1) {
    let listaTareas = $('#listaTareas');
    let paginationContainer = $('#pagination-container');

    $.ajax({
        url: urlWithParam + '&page=' + page,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log("Respuesta de la API:", data);
            listaTareas.empty();
            paginationContainer.empty();

            console.log("ALGO PASO AQUI")

            
            const tasksPerPage = 10;
            let isServerPagination = (data.count !== undefined);
            let totalTasks = isServerPagination ? data.count : ((data.results || data.tareas || data).length);
            let totalPages = Math.ceil(totalTasks / tasksPerPage);

            let tareas = [];

            if (isServerPagination) {
                // Si hay paginación en el servidor, usamos los resultados
                tareas = data.results || [];
            } else {
                // Si no hay paginación en el servidor, hacemos el slice de la lista
                let taskList = (data.results || data.tareas || data) || [];
                let startIndex = (page - 1) * tasksPerPage;
                let endIndex = startIndex + tasksPerPage;

                // Asegúrate de que el índice de corte no se pase más allá del tamaño de la lista
                endIndex = Math.min(endIndex, taskList.length);

                tareas = taskList.slice(startIndex, endIndex);
            }

            
            console.log(tareas.length);
            if (Array.isArray(data)) {
            data.forEach((tarea, index) => {
                console.log(`Tarea ${index + 1}:`, tarea); // Muestra cada tarea
                console.log(`Apoyo en tarea ${index + 1}:`, tarea.apoyo); // Muestra el campo apoyo de cada tarea
                
                if (Array.isArray(tarea.apoyo)) {
                    console.log(`Apoyo (en tarea ${index + 1}) es un array:`, tarea.apoyo);
                } else {
                    console.log(`Apoyo (en tarea ${index + 1}) NO es un array:`, tarea.apoyo);
                }
            });
        } else {
            console.error("Los datos no contienen un array de tareas.");
        }
    
            if (tareas.length > 0) {
                let tareasHtml = '<ul class="list-group">';
                tareas.forEach(tarea => {
                    let editarUrl = `/tareas/editar_tarea/${tarea.id}/`;
                    tareasHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center task-item" data-tarea-id="${tarea.id}">
                            <div class="col-3">
                            
                                <span>
                                <strong>${tarea.descripcion}</strong> - ${tarea.funcionario__nombre}<br>
                                fecha de Creación: ${new Date(tarea.fecha_creacion + "T00:00:00").toLocaleDateString()} <br>
                                fecha de Entrega: ${new Date(tarea.fecha_entrega.split("T")[0] + "T00:00:00").toLocaleDateString()}<br>
                                <span style="font-weight: bold; color: #333;">Prioridad:</span> 
                                <span class="${tarea.prioridad === 'alta' ? 'text-danger' : (tarea.prioridad === 'media' ? 'text-warning' : 'text-success')}">
                                    ${tarea.prioridad}
                                </span><br>
                                
                            </div>
                            <div class="justify-content-center text-align-start" style="width: 250px;">
                            <strong>Apoyo(s):</strong>
                            
       ${tarea.apoyo?.length > 0 ? `
  <ul class="apoyo-lista"> 
    ${tarea.apoyo.map(apoyo => `
      <li class="apoyo-item">
        <strong>${apoyo.nombre}:</strong> ${apoyo.descripcion || 'No disponible'}
      </li>
    `).join('')}
  </ul>
` : '<span>No hay funcionarios de apoyo.</span>'}
</div>
<div>
                    <strong style="color: green; font-weight: bold;">En Proceso</strong>
                </div>
                            </span>
                             <div>
                                <a href="${editarUrl}" class="btn btn-sm btn-warning">✏️ Editar</a>
                            {% if user.is_superuser %}
                                <button type="button" class="btn btn-sm btn-danger eliminar-tarea">❌ Eliminar</button>
                                <button type="button" class="btn btn-sm btn-success completar-tarea" data-tarea-id="${tarea.id}">✅ Completar</button>
                            </div>
                            {% endif %}
                        </li>

                    `;
                });
                tareasHtml += '</ul>';
                listaTareas.html(tareasHtml);
            } else {
                listaTareas.html('<p class="text-muted text-center">⚠️ No hay tareas registradas.</p>');
            }

            if (totalPages > 1) {
                let paginationHtml = '<ul class="pagination">';
                paginationHtml += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page - 1}">Anterior</a></li>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<li class="page-item ${page === i ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }
                paginationHtml += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page + 1}">Siguiente</a></li>`;
                paginationHtml += '</ul>';
                paginationContainer.html(paginationHtml);

                paginationContainer.off('click', 'a.page-link').on('click', 'a.page-link', function(e) {
                    e.preventDefault();
                    let newPage = $(this).data('page');
                    if (newPage) {
                        loadTasks(urlWithParam, newPage);
                    }
                });
            }
        },
        error: function(error) {
            console.error("Error al cargar tareas:", error);
            listaTareas.html('<p class="text-danger text-center">⚠️ Error al cargar las tareas.</p>');
        }
    });
}

// ✅ Ahora esta función puede acceder a loadTasks()
$(document).on('click', '.eliminar-tarea', function(e) {
        e.preventDefault();
        let $tareaItem = $(this).closest('.task-item');
        let tareaId = $tareaItem.data('tarea-id');

        if (confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
            $.ajax({
                url: `/tareas/eliminar_tarea/${tareaId}/`,
                type: 'POST', // o 'DELETE' dependiendo de cómo tengas configurado tu formulario
                data: {
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // token CSRF para Django
                },
                success: function(response) {
                    // Si la tarea se elimina correctamente, quitamos el elemento del DOM
                    $tareaItem.fadeOut();

                    // Recargar las tareas del funcionario seleccionado
                    let funcionarioId = $('#funcionarioSelect').val();
                    if (funcionarioId) {
                        let baseUrl = $('#funcionarioSelect').data('url');
                        let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';

                        $.ajax({
                            url: jsonUrl,
                            type: 'GET',
                            dataType: 'json',
                            success: function(response) {
                            $tareaItem.fadeOut(300, function() {
                                $(this).remove();

                                let currentPage = parseInt($('#pagination-container .page-item.active').text());
                                let remainingTasksInPage = $('.task-item').length;

                                if (remainingTasksInPage === 0 && currentPage > 1) {
                                    currentPage--; // Retrocede si la página quedó vacía
                                }
                                else{
                                    currentPage  = 1
                                }

                                let funcionarioId = $('#funcionarioSelect').val();
                                let baseUrl = $('#funcionarioSelect').data('url');
                                let urlWithParam = baseUrl.replace('0', funcionarioId) + 'json/?funcionario=' + funcionarioId;

                                loadTasks(urlWithParam, currentPage);
                            });
                        },
                            error: function(error) {
                                console.error("Error al cargar tareas:", error);
                                listaTareas.html('<p class="text-danger text-center">⚠️ Error al cargar las tareas.</p>');
                            }
                        });
                    }
                },
                error: function(error) {
                    console.error("Error al eliminar la tarea:", error);
                    alert("Error al eliminar la tarea. Inténtalo de nuevo.");
                }
            });
        }
    });


$(document).on('click', '.completar-tarea', function() {
    let tareaId = $(this).data('tarea-id');
    let $tareaItem = $(this).closest('.task-item');

    $.ajax({
        url: `/tareas/completar_tarea/${tareaId}/`, 
        type: 'GET',
        data: {
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() 
        },
        success: function(response) {
            // Eliminar la tarea completada de la lista

            // Mostrar el modal de tarea completada
            $('#tareaCompletadaModal').modal('show');

            // Acción cuando el modal se cierra
            $('#closeTareaCompletadaModal').click(function() {
                $('#tareaCompletadaModal').modal('hide');

                // Obtener el funcionario seleccionado
                let funcionarioId = $('#funcionarioSelect').val();
                
                // Verificar si se seleccionó un funcionario
                if (funcionarioId) {
                    // Crear la URL base con el funcionario seleccionado
                    let baseUrl = $('#funcionarioSelect').data('url');
                    let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';

                    // Realizar una nueva solicitud AJAX para obtener las tareas filtradas por el funcionario
                    $.ajax({
                        url: jsonUrl,
                        type: 'GET',
                        dataType: 'json',
                        success: function(response) {
                            $tareaItem.fadeOut(300, function() {
                                $(this).remove();
                                
                                

                                let currentPage = parseInt($('#pagination-container .page-item.active').text());
                                let remainingTasksInPage = $('.task-item').length;

                                if (remainingTasksInPage === 0 && currentPage > 1) {
                                    currentPage--; // Retrocede si la página quedó vacía
                                }
                                else{
                                    currentPage  = 1
                                }

                                let funcionarioId = $('#funcionarioSelect').val();
                                let baseUrl = $('#funcionarioSelect').data('url');
                                let urlWithParam = baseUrl.replace('0', funcionarioId) + 'json/?funcionario=' + funcionarioId;

                                loadTasks(urlWithParam);
                            });
                        },
                        error: function(error) {
                            console.error("Error al cargar tareas:", error);
                            listaTareas.html('<p class="text-danger text-center">⚠️ Error al cargar las tareas.</p>');
                        }
                    });
                } else {
                    // Si no se seleccionó un funcionario, recargar la página para actualizar la vista
                    window.location.reload();
                }
            });
        },
        error: function(error) {
            console.error("Error al completar tarea:", error);
            alert("Error al completar la tarea. Inténtalo de nuevo.");
        }
    });
});

    $(document).on('click', 'a[href^="/tareas/editar_tarea/"]', function(e) {
        e.preventDefault();
        let editarUrl = $(this).attr('href');
        let idFuncionario = $('#funcionarioSelect').val();

        sessionStorage.setItem('funcionarioSeleccionado', idFuncionario);
        window.location.href = editarUrl;
    });

    let funcionarioAlmacenado = sessionStorage.getItem('funcionarioSeleccionado');
    if (funcionarioAlmacenado) {
        $('#funcionarioSelect').val(funcionarioAlmacenado).trigger('change');
        sessionStorage.removeItem('funcionarioSeleccionado');
    }
    
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function confirmarEliminacion(event, element) {
        event.preventDefault();  // Evita la navegación automática
        let tareaId = element.getAttribute("data-tarea-id");
        let eliminarUrl = `{% url 'eliminar_tarea' 0 %}`.replace("0", tareaId);
        
        // Establecer la URL en el botón de confirmación
        document.getElementById("confirmarEliminarBtn").setAttribute("href", eliminarUrl);
        
        // Mostrar el modal
        let modal = new bootstrap.Modal(document.getElementById("confirmarEliminacionModal"));
        modal.show();
    }
</script>

</div>
</html>